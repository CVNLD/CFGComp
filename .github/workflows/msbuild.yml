name: MSBuild
on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main" ]
env:
  SOLUTION_FILE_PATH: ./CFGComp.sln
  BUILD_CONFIGURATION: Release
permissions:
  contents: write
jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2
    - name: Restore NuGet packages
      working-directory: ${{github.workspace}}
      run: nuget restore ${{env.SOLUTION_FILE_PATH}}
    - name: Build
      working-directory: ${{github.workspace}}
      run: msbuild /m /p:Configuration=${{env.BUILD_CONFIGURATION}} ${{env.SOLUTION_FILE_PATH}}
    - name: List output directory
      run: |
        Get-ChildItem -Path "${{github.workspace}}\x64\${{env.BUILD_CONFIGURATION}}" -Recurse
    - name: Check for executable
      run: |
        $exePath = "${{github.workspace}}\x64\${{env.BUILD_CONFIGURATION}}\CFGComp.exe"
        if (Test-Path $exePath) {
          echo "Executable found at $exePath"
          echo "EXE_PATH=$exePath" >> $env:GITHUB_ENV
        } else {
          echo "Executable not found at $exePath"
          exit 1
        }
    - name: Debug Info
      run: |
        echo "Current ref: ${{ github.ref }}"
        echo "Is this a tag? ${{ startsWith(github.ref, 'refs/tags/') }}"
        echo "Executable path: ${{ env.EXE_PATH }}"
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.EXE_PATH }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Upload artifact for debugging
      uses: actions/upload-artifact@v2
      with:
        name: CFGComp-executable
        path: ${{ env.EXE_PATH }}
